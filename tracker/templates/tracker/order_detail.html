{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}

{% block title %}Order Details{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1"><i class="fa fa-file-text me-2 text-primary"></i>Order {{ order.order_number }}</h4>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}"><i class="fa fa-list me-1"></i>Orders</a></li>
                  <li class="breadcrumb-item active">{{ order.order_number }}</li>
                </ol>
              </nav>
            </div>
            <div class="d-flex gap-2 align-items-center">
              {% if order.type == 'service' %}
                <span class="badge bg-primary fs-6 px-3 py-2"><i class="fa fa-wrench me-1"></i>Service</span>
              {% elif order.type == 'sales' %}
                <span class="badge bg-success fs-6 px-3 py-2"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
              {% elif order.type == 'inquiry' %}
                <span class="badge bg-info fs-6 px-3 py-2"><i class="fa fa-question-circle me-1"></i>Inquiry</span>
              {% else %}
                <span class="badge bg-secondary fs-6 px-3 py-2">{{ order.type }}</span>
              {% endif %}
              
              {% if order.status == 'created' %}
                <span class="badge bg-secondary fs-6 px-3 py-2"><i class="fa fa-play me-1"></i>Start</span>
              {% elif order.status == 'in_progress' %}
                <span class="badge bg-warning text-dark fs-6 px-3 py-2"><i class="fa fa-clock me-1"></i>In Progress</span>
              {% elif order.status == 'overdue' %}
                <span class="badge bg-danger fs-6 px-3 py-2"><i class="fa fa-exclamation-triangle me-1"></i>Overdue</span>
              {% elif order.status == 'completed' %}
                <span class="badge bg-success fs-6 px-3 py-2"><i class="fa fa-check me-1"></i>Completed</span>
              {% elif order.status == 'cancelled' %}
                <span class="badge bg-dark fs-6 px-3 py-2"><i class="fa fa-times me-1"></i>Cancelled</span>
              {% else %}
                <span class="badge bg-light text-dark fs-6 px-3 py-2">{{ order.status }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <!-- Customer & Order Info -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fa fa-user text-primary"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Customer</small>
                  <a href="{% url 'tracker:customer_detail' pk=order.customer.id %}" class="text-decoration-none fw-medium">{{ order.customer.full_name }}</a>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fa fa-flag text-warning"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Priority</small>
                  {% if order.priority == 'low' %}
                    <span class="badge bg-success text-white">Low</span>
                  {% elif order.priority == 'medium' %}
                    <span class="badge bg-primary text-white">Medium</span>
                  {% elif order.priority == 'high' %}
                    <span class="badge bg-warning text-dark">High</span>
                  {% elif order.priority == 'urgent' %}
                    <span class="badge bg-danger text-white"><i class="fa fa-fire me-1"></i>Urgent</span>
                  {% else %}
                    <span class="badge bg-secondary text-white">{{ order.priority }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Details -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-info-circle me-2"></i>Order Details</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted">Description</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.description|default:"No description provided" }}</div>
              </div>
            </div>
            {% if order.notes %}
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted">Notes</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.notes }}</div>
              </div>
            </div>
            {% endif %}
            {% if order.cancellation_reason %}
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted">Cancellation Reason</label>
                <div class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded">{{ order.cancellation_reason }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Attachments -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-paperclip me-2"></i>Attachments & Signatures</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if order.signature_file %}
            <div class="col-md-6">
              <div class="text-center p-3 border rounded">
                <i class="fa fa-signature text-primary mb-2 d-block"></i>
                <small class="text-muted d-block mb-2">Digital Signature</small>
                <img src="{{ order.signature_file.url }}" alt="Signature" class="img-fluid rounded shadow-sm" style="max-height: 150px;">
                {% if order.signed_by %}
                <div class="mt-2">
                  <small class="text-muted">Signed by: {{ order.signed_by.get_full_name|default:order.signed_by.username }}</small>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% if order.completion_attachment %}
            <div class="col-md-6">
              <div class="text-center p-3 border rounded">
                <i class="fa fa-file text-success mb-2 d-block"></i>
                <small class="text-muted d-block mb-2">Completion Attachment</small>
                <a href="{{ order.completion_attachment.url }}" target="_blank" class="btn btn-outline-success btn-sm">
                  <i class="fa fa-download me-1"></i>Download File
                </a>
              </div>
            </div>
            {% endif %}
            {% if not order.signature_file and not order.completion_attachment %}
            <div class="col-12">
              <div class="text-center py-4 text-muted">
                <i class="fa fa-inbox fa-2x mb-2 d-block"></i>
                <p class="mb-0">No attachments available</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      {% if order.status != 'completed' and order.status != 'cancelled' %}
      <!-- Complete Order -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success bg-opacity-10">
          <h6 class="mb-0 text-success"><i class="fa fa-check-circle me-2"></i>Complete Order</h6>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" action="{% url 'tracker:complete_order' pk=order.id %}">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-medium"><i class="fa fa-signature me-1"></i>Signature Image</label>
                <input type="file" name="signature_file" accept="image/*" class="form-control">
                <small class="text-muted">Upload customer signature</small>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium"><i class="fa fa-paperclip me-1"></i>Completion Attachment</label>
                <input type="file" name="completion_attachment" class="form-control">
                <small class="text-muted">Upload completion document</small>
              </div>
            </div>
            <div class="alert alert-info mt-3 mb-0">
              <i class="fa fa-info-circle me-1"></i>
              Upload either a signature image or an attachment (one is required).
            </div>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-success" type="submit"><i class="fa fa-check me-1"></i>Mark as Completed</button>
              <a class="btn btn-outline-secondary" href="{% url 'tracker:order_edit' pk=order.id %}"><i class="fa fa-edit me-1"></i>Edit Order</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Cancel Order -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger bg-opacity-10">
          <h6 class="mb-0 text-danger"><i class="fa fa-times-circle me-2"></i>Cancel Order</h6>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'tracker:cancel_order' pk=order.id %}">
            {% csrf_token %}
            <label class="form-label fw-medium"><i class="fa fa-comment me-1"></i>Cancellation Reason</label>
            <textarea name="reason" class="form-control" rows="3" required placeholder="Please provide a reason for cancellation..."></textarea>
            <div class="mt-3">
              <button class="btn btn-danger" type="submit"><i class="fa fa-times me-1"></i>Cancel Order</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-bolt me-2"></i>Quick Actions</h6>
        </div>
        <div class="card-body d-grid gap-2">
          <a href="{% url 'tracker:orders_list' %}" class="btn btn-outline-primary">
            <i class="fa fa-arrow-left me-2"></i>Back to Orders
          </a>
          <a href="{% url 'tracker:order_edit' pk=order.id %}" class="btn btn-outline-success">
            <i class="fa fa-edit me-2"></i>Edit Order
          </a>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
              <i class="fa fa-cog me-2"></i>More Actions
            </button>
            <ul class="dropdown-menu w-100">
              <li><a class="dropdown-item js-complete-one" href="#" data-order-id="{{ order.id }}"><i class="fa fa-check me-2 text-success"></i>Mark Completed</a></li>
              <li><a class="dropdown-item js-cancel-one" href="#" data-order-id="{{ order.id }}"><i class="fa fa-times me-2 text-warning"></i>Cancel Order</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'tracker:order_delete' pk=order.id %}" onsubmit="return confirm('Delete this order?');">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{% url 'tracker:orders_list' %}">
                  <button type="submit" class="dropdown-item text-danger"><i class="fa fa-trash me-2"></i>Delete Order</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-clock me-2"></i>Timeline</h6>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-marker bg-primary"></div>
              <div class="timeline-content">
                <small class="text-muted">Created</small>
                <div class="fw-medium">{{ order.created_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% if order.started_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-warning"></div>
              <div class="timeline-content">
                <small class="text-muted">Started</small>
                <div class="fw-medium">{{ order.started_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
            {% if order.completed_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-success"></div>
              <div class="timeline-content">
                <small class="text-muted">Completed</small>
                <div class="fw-medium">{{ order.completed_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
            {% if order.cancelled_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-danger"></div>
              <div class="timeline-content">
                <small class="text-muted">Cancelled</small>
                <div class="fw-medium">{{ order.cancelled_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Additional Info -->
      {% if order.signed_by or order.completion_date %}
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-info me-2"></i>Additional Information</h6>
        </div>
        <div class="card-body">
          {% if order.signed_by %}
          <div class="mb-3">
            <small class="text-muted d-block">Signed By</small>
            <div class="fw-medium">{{ order.signed_by.get_full_name|default:order.signed_by.username }}</div>
          </div>
          {% endif %}
          {% if order.completion_date %}
          <div class="mb-0">
            <small class="text-muted d-block">Completion Date</small>
            <div class="fw-medium">{{ order.completion_date|date_medium }}</div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 30px;
}
.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}
.timeline-item {
  position: relative;
  margin-bottom: 20px;
}
.timeline-item:last-child {
  margin-bottom: 0;
}
.timeline-marker {
  position: absolute;
  left: -26px;
  top: 2px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 0 2px #dee2e6;
}
.timeline-content {
  padding-left: 10px;
}
.dropdown-menu {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}
.dropdown-item {
  color: #212529;
  background-color: transparent;
}
.dropdown-item:hover,
.dropdown-item:focus {
  color: #ffffff;
  background-color: #0d6efd;
}
.dropdown-item.text-success:hover {
  background-color: #198754;
  color: #ffffff;
}
.dropdown-item.text-warning:hover {
  background-color: #fd7e14;
  color: #ffffff;
}
.dropdown-item.text-danger:hover {
  background-color: #dc3545;
  color: #ffffff;
}
.dropdown-item.text-primary:hover {
  background-color: #0d6efd;
  color: #ffffff;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function statusBadge(status){
    switch(status){
      case 'created': return '<span class="badge bg-secondary">Start</span>';
      case 'in_progress': return '<span class="badge bg-warning text-dark">In Progress</span>';
      case 'overdue': return '<span class="badge bg-danger">Overdue</span>';
      case 'completed': return '<span class="badge bg-success">Completed</span>';
      case 'cancelled': return '<span class="badge bg-dark">Cancelled</span>';
      default: return '<span class="badge bg-light text-dark">'+(status||'-')+'</span>';
    }
  }
  function fmt(dt){ if(!dt) return '-'; try{ return new Date(dt).toLocaleString(); }catch(e){ return '-'; } }
  const id = {{ order.id }};
  function refresh(){
    fetch(`/api/orders/${id}/status/`)
      .then(r=>r.json()).then(j=>{
        if(!j.success) return;
        // Update status badge in overview
        const statusWrap = document.querySelectorAll('.col-md-6 .mb-2')[1];
        if(statusWrap){ statusWrap.querySelector('div').innerHTML = statusBadge(j.status); }
        // Update timestamps
        const created = document.querySelectorAll('.col-md-6 .mb-2')[2];
        const started = document.querySelectorAll('.col-md-6 .mb-2')[3];
        const completed = document.querySelectorAll('.col-md-6 .mb-2')[4];
        const cancelled = document.querySelectorAll('.col-md-6 .mb-2')[5];
        if(created) created.querySelector('div').innerHTML = fmt(j.created_at);
        if(started) started.querySelector('div').innerHTML = j.started_at ? fmt(j.started_at) : '-';
        if(completed) completed.querySelector('div').innerHTML = j.completed_at ? fmt(j.completed_at) : '-';
        if(cancelled) cancelled.querySelector('div').innerHTML = j.cancelled_at ? fmt(j.cancelled_at) : '-';
        // Hide/Show completion/cancel forms based on status
        const completeCard = document.querySelector('form[action$="/complete/"]')?.closest('.card');
        const cancelCard = document.querySelector('form[action$="/cancel/"]')?.closest('.card');
        if(j.status==='completed' || j.status==='cancelled'){
          if(completeCard) completeCard.style.display = 'none';
          if(cancelCard) cancelCard.style.display = 'none';
        } else {
          if(completeCard) completeCard.style.display = '';
          if(cancelCard) cancelCard.style.display = '';
        }
      });
  }
  setInterval(refresh, 12000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refresh(); });
  refresh();

  // Inline actions
  function post(url, fd){ return fetch(url, { method:'POST', body: fd }); }
  document.addEventListener('click', function(e){
    const c1 = e.target.closest('.js-complete-one');
    const c2 = e.target.closest('.js-cancel-one');
    if(c1){
      e.preventDefault();
      const fd = new FormData();
      fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = ()=>{ if(input.files.length){ fd.append('completion_attachment', input.files[0]); post(`/orders/${id}/complete/`, fd).then(()=>refresh()); } };
      input.click();
    }
    if(c2){
      e.preventDefault();
      const reason = prompt('Reason for cancellation?');
      if(!reason) return;
      const fd = new FormData();
      fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      fd.append('reason', reason);
      post(`/orders/${id}/cancel/`, fd).then(()=>refresh());
    }
  });
})();
</script>
{% endblock %}